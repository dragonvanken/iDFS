 // ç¼–è¯‘å‘½ä»¤ ï¼špython -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I. MasterForClient.proto
syntax = "proto3";

// è¿™æ˜¯æ§åˆ¶æœåŠ¡å™¨Masterä¸ºå®¢æˆ·Clientæä¾›çš„æœåŠ¡MFCçš„åè®®

service MFC {
    //æœåŠ¡ï¼šä¸ºå®¢æˆ·æä¾›æ–‡ä»¶ç›®å½•æ ‘ç»“æ„
    //è¯·æ±‚ï¼šæ— å†…å®¹è¯·æ±‚
    //è¿”å›ï¼šå­˜å‚¨æ–‡ä»¶è·¯å¾„çš„å­—ç¬¦ä¸²æµ
    rpc getFiletree(EmptyArg) returns (stream Str) {}

    //äº‹åŠ¡ï¼šæ–‡ä»¶ä¸Šä¼ 
    //æœåŠ¡ï¼šå®¢æˆ·è·å–æ–‡ä»¶åˆ†å—ä¿¡æ¯å¹¶ç”³è¯·Data Serverä»¥ä¾›æ–‡ä»¶ä¸Šä¼ 
    //è¯·æ±‚ï¼šé¢„ä¸Šä¼ æ–‡ä»¶å¤§å°å’Œåœ¨DFSä¸­å­˜æ”¾è·¯å¾„
    //è¿”å›ï¼šçŠ¶æ€ç ã€åˆ†é…çš„ä¸Šä¼ æœåŠ¡å™¨ï¼ˆData Serverï¼‰ä¿¡æ¯ã€æ–‡ä»¶åˆ†å—ä¿¡æ¯
    rpc getChunkInfoAndAllocatedDataServer(getChunkInfoAndAllocatedDataServerRequest) returns (stream ChunkStructor) {}

    //æœåŠ¡ï¼šåˆ›å»ºæ–‡ä»¶å¤¹
    //è¯·æ±‚ï¼šæ–‡ä»¶å¤¹è·¯å¾„
    //è¿”å›ï¼šçŠ¶æ€ğŸ‡
    rpc createFolder(createFolderRequest) returns (ACK) {}

    //äº‹ç‰©ï¼šæ–‡ä»¶ä¸‹è½½
    //æœåŠ¡ï¼šå®¢æˆ·è·å–æ–‡ä»¶ä¿¡æ¯å¹¶ç”³è¯·Data Serverä»¥ä¾›æ–‡ä»¶ä¸‹è½½
    //è¯·æ±‚ï¼šé¢„ä¸‹è½½æ–‡ä»¶åœ¨DFSä¸­å­˜æ”¾è·¯å¾„
    //è¿”å›ï¼šçŠ¶æ€ç ã€åˆ†é…çš„ä¸‹è½½æœåŠ¡å™¨ï¼ˆData Serverï¼‰ä¿¡æ¯ã€æ–‡ä»¶åˆ†å—ä¿¡æ¯
    rpc requestDownloadFromMaster(downloadRequestInfo) returns (stream targetInfo) {}


    //äº‹ç‰©ï¼šæ–‡ä»¶åˆ é™¤
    //æœåŠ¡ï¼šå®¢æˆ·åˆ é™¤æŒ‡å®šè·¯å¾„ä¸‹çš„æŸä¸ªæ–‡ä»¶
    //è¯·æ±‚ï¼šæ–‡ä»¶è·¯å¾„
    //è¿”å›ï¼šçŠ¶æ€ç ï¼Œè¿”å›ä¿¡æ¯
    rpc deleteFile(FilePath) returns (ACK) {}
}

//æ— å‚æ•°
message EmptyArg{
}

message Str{
    string name = 1;
    bool isFolder = 2;
}

message getChunkInfoAndAllocatedDataServerRequest{
    int32 size = 1;
    string path = 2;
}

 message ChunkStructor{
     int32 ChunkSize = 1; // æ–‡ä»¶å—å¤§å°
     int32 ChunkId = 2;  // å—æ ‡è®°
     int32 inFID = 3;    // å±äºå“ªä¸€ä¸ªæ–‡ä»¶
     int32 offset = 4 ;  // æ–‡ä»¶å—åœ¨æ–‡ä»¶å†…çš„åç§»
     int32 StoreDID = 5; // å­˜å‚¨æœåŠ¡å™¨ç¼–å·
     string ip =6;
     int32 port = 7;
}

message FilePath{
    string path = 1;    //è¦åˆ é™¤çš„æ–‡ä»¶è·¯å¾„
    bool isFolder = 2;  //æ–‡ä»¶ä¿¡æ¯ï¼Œæ˜¯å¦æ˜¯æ–‡ä»¶å¤¹
}

message ACK{
    bool feedBack = 1; //æˆåŠŸä¸å¦çš„ç¡®è®¤ä¿¡æ¯
    string msg = 2;    //è¿”å›ä¿¡æ¯
}

message downloadRequestInfo{
    string path = 1;    //å‘masterè¯·æ±‚ä¸‹è½½æ–‡ä»¶çš„è·¯å¾„
}

// clientç”¨ä»¥å‘dataServerè¯·æ±‚ä¸‹è½½
message targetInfo{
    string ip = 1;      //dataServerçš„åœ°å€
    int32 port = 2;     //dataServerçš„ç«¯å£
    int32 ChunkSize = 3;
    int32 ChunkId = 4;
    bool status = 5;
}

message createFolderRequest{
    string destination = 1;
}